<html>
<head>
</head>
<body>
    <div class= "container">
        <div id=login>
            <div class="alert">
                <strong>Warning!</strong> Must login to Spotify. Click here
                <button id="login-button" class="btn btn-primary">Log in with Spotify</button>
            </div>
        </div>
    </div>
    <div id="loggedin">
        <div id="user-profile">
        </div>
        <div id="oauth">
        </div>
      </div>
    </div>

    <script id="user-profile-template" type="text/x-handlebars-template">
        <h1>Logged in as {{display_name}}</h1>
        <div class="media">
          <div class="pull-left">
            <img class="media-object" width="150" src="{{images.0.url}}" />
          </div>
          <div class="media-body">
            <dl class="dl-horizontal">
              <dt>Display name</dt><dd class="clearfix">{{display_name}}</dd>
              <dt>Id</dt><dd>{{id}}</dd>
              <dt>Email</dt><dd>{{email}}</dd>
              <dt>Spotify URI</dt><dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
              <dt>Link</dt><dd><a href="{{href}}">{{href}}</a></dd>
              <dt>Profile Image</dt><dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
              <dt>Country</dt><dd>{{country}}</dd>
            </dl>
          </div>
        </div>
      </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <p id="demo"></p>
    <script>
      (function() {

        var stateKey = 'spotify_auth_state';

        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }

        /**
         * Generates a random string containing numbers and letters
         * @param  {number} length The length of the string
         * @return {string} The generated string
         */
        function generateRandomString(length) {
          var text = '';
          var possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';

          for (var i = 0; i < length; i++) {
            text += possible.charAt(Math.floor(Math.random() * possible.length));
          }
          return text;
        };

        var userProfileSource = document.getElementById('user-profile-template').innerHTML,
            userProfileTemplate = Handlebars.compile(userProfileSource),
            userProfilePlaceholder = document.getElementById('user-profile');

        var params = getHashParams();

        var access_token = params.access_token,
            state = params.state,
            storedState = localStorage.getItem(stateKey);
        var limit ='20';
        var market = 'US'; 

        let queryMap = new Map();
        //GOAL: set each of these to variables returned from watson
        var seedGenre = 'country'; 
        var valence = '0';
        var energy = '.5';
        var danceability ='';
        var instrumentalness = '';
        var liveness = '1';
        var loudness = '';
        var popularity = '';
        var speechiness = '';
        var tempo = '';
        var acousticness ='1';
      //  queryMap.set('seedGenre', 'country');
        queryMap.set('valence', valence);
        queryMap.set('energy', energy);
        queryMap.set('danceability', danceability);
        queryMap.set('liveness', liveness);
        queryMap.set('loudness', loudness);
        queryMap.set('popularity', popularity);
        queryMap.set('speechiness', speechiness);
        queryMap.set('tempo', tempo);
        queryMap.set('acousticness', acousticness);

//This adds each query parameter to the query (omitting null values)      
              var url='';
                       queryMap.forEach((values, key)=>{
                  if(values!==''){
                    url+='&target_' + key+ '=' + values;
                  }
                })
                      console.log(url); 
                       console.log('https://api.spotify.com/v1/recommendations?seed_genres=' + seedGenre + url +'&limit=' + limit +'&market=' + market );
            //This call creates the query that returns list of songs
              $.ajax({
               // url: 'https://api.spotify.com/v1/recommendations?seed_genres=' + seedGenre +'&target_valence=' + valence + '&target_energy=' + energy + '&limit=' + limit +'&market=' + market ,
                url:'https://api.spotify.com/v1/recommendations?seed_genres=' + seedGenre + url +'&limit=' + limit +'&market=' + market ,

                type: 'GET',
                dataType: 'JSON',
                headers: {
                  'Authorization': 'Bearer ' + access_token
                },
                success: function(response) {
               var obj =JSON.parse(JSON.stringify(response));
       //        console.log(obj);
     //           console.log(response);
            //    document.getElementById("demo").innerHTML = obj.tracks[0].uri;
                var track1 = obj.tracks[0].uri;
                var playlistName = 'Example Playlist'
                  $.ajax({
                             url: 'https://api.spotify.com/v1/users/ryleefra/playlists',
                              type: 'POST',
                              dataType: 'JSON',
                        headers: {

                          'Authorization': 'Bearer ' + access_token,

                          'Content-Type': 'application/json'
                        },
                        data: JSON.stringify({'name': playlistName}),
                      
                        success: function(response){
                          var i=0;
                          var tracks = 'uris=';
                          for(i=0; i<20; i++){
                            tracks += obj.tracks[i].uri+',';
                          }
                        
                       //   var playlist = '2If4YggzwIw1NZFmEoO8Zb';
                        //   console.log(JSON.stringify(response));
                            var playlistJSON = JSON.parse(JSON.stringify(response));
                            var playlist = playlistJSON.id;
                    //        console.log(playlistJSON);
                             $.ajax({
                                   url: 'https://api.spotify.com/v1/users/ryleefra/playlists/' +playlist +'/tracks?' + tracks,
                                    type: 'POST',
                                    dataType: 'JSON',
                              headers: {

                                'Authorization': 'Bearer ' + access_token,

                                'Content-Type': 'application/json'
                              },
                            
                              success: function(response){
                              
//                                 console.log(JSON.stringify(response));
                              }
                              })
                        }
                        })
                 //  console.log(JSON.stringify(response));
                }
            
            })
        if (access_token && (state == null || state !== storedState)) {
          alert('There was an error during the authentication');
        } else {
          localStorage.removeItem(stateKey);
          if (access_token) {
            $.ajax({
                url: 'https://api.spotify.com/v1/me',
                headers: {
                  'Authorization': 'Bearer ' + access_token
                },
                success: function(response) {
   //                console.log(JSON.stringify(response));
                  userProfilePlaceholder.innerHTML = userProfileTemplate(response);
                  const element = document.querySelector('.chatElement')
                window.watsonAssistantChatOptions = {
            integrationID: "b6a8e4ed-a8ca-4a58-ad7c-d903e401735d", // The ID of this integration.
            region: "us-south", // The region your integration is hosted in.
            serviceInstanceID: "eb26c4ad-a1cb-4fee-9084-dede2ea4e023", // The ID of your service instance.
            element: element,
            hideCloseButton: true,
            showLauncher: false,
            openChatByDefault: true,
            onLoad: function(instance) {
                instance.updateCSSVariables({
                    'BASE-font-family': '"Times New Roman", Times, serif'
                });
                instance.render();
            }
        };
        setTimeout(function(){
            const t=document.createElement('script');
            t.src="https://web-chat.global.assistant.watson.appdomain.cloud/loadWatsonAssistantChat.js";
            document.head.appendChild(t);
        });
                  $('#login').hide();
                  $('#loggedin').show();
                }
            });
          } else {
              $('#login').show();
              $('#loggedin').hide();
          }
 
          document.getElementById('login-button').addEventListener('click', function() {

            var client_id = 'f4c692875fc546129664e90e720610a6'; // Your client id
        var redirect_uri = 'http://localhost:8888/chat-bot.html'; // Your redirect uri

            var state = generateRandomString(16);

            localStorage.setItem(stateKey, state);
            var scope = 'user-read-private user-read-email playlist-modify-public';

            var url = 'https://accounts.spotify.com/authorize';
            url += '?response_type=token';
            url += '&client_id=' + encodeURIComponent(client_id);
            url += '&scope=' + encodeURIComponent(scope);
            url += '&redirect_uri=' + encodeURIComponent(redirect_uri);
            url += '&state=' + encodeURIComponent(state);
            window.location = url;
      
          }, false);
        }
      })();
    </script>
    <script>
       
    </script>
</body>
</html>